plugins{
    id "kotlin2js" version "1.3.21"
    id 'kotlinx-serialization' version '1.3.21'
    id "org.jetbrains.kotlin.frontend" version "0.0.45"
}
group 'kotlin-poc-frontend-ktor-client'
version '1.0-SNAPSHOT'

ext{
    web_dir = "web"
}

repositories {
    mavenCentral()
    maven { url "https://kotlin.bintray.com/kotlinx" }
}

dependencies {
    compile "org.jetbrains.kotlin:kotlin-stdlib-js"
    compile "org.jetbrains.kotlinx:kotlinx-serialization-runtime-js:0.10.0"
    compile "io.ktor:ktor-client-js:1.1.3"
    compile "io.ktor:ktor-client-json-js:1.1.3"
}

kotlinFrontend {
    npm{
        dependency "text-encoding"
    }
    webpackBundle {
        contentPath = file('src/main/resources/web')
        if (project.hasProperty('prod')) {
            mode = "production"
        }
    }
}

clean.doFirst() {
    delete("${web_dir}")
}

bundle.doLast() {
    copy {
        from "${buildDir}/resources/main/web"
        from "${buildDir}/bundle"
        into "${web_dir}"
    }
}

compileKotlin2Js {
    kotlinOptions.moduleKind = 'commonjs'
    kotlinOptions.freeCompilerArgs += ['-Xuse-experimental=kotlinx.serialization.ImplicitReflectionSerializer']

}